<html>
    <head>
        <style type="text/css">
            #outputDiv canvas {
                width: 100%;
                height: 100%;
            }
            .container {
                display: table;
                width:100%;
                height:100%
            }
            .container div {
                display: table-row;
            }

            #dropNotification {
                position: absolute;
                top:100px;
                left: 20px;
                right:20px;
                text-align:center;
                pointer-events: none;
            }

            .boxed {
                background-color: white;
                box-shadow: 5px 5px 2px #999999;
                border: 1px solid black;
                border-radius: 10px;
            }

            #aboutBox {
                position:absolute;
                top:50px;
                left: 25%;
                width: 50%;
                padding-left: 20px;
                padding-right: 20px;
            }
            img.round-image {
                border-radius: 50%;
            }
			
            #method {
                display: none;
            }
        </style>
	<title>Cvisim 色觉模拟器</title>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js'></script>
        <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css'/>
    </head>
    <body>
        <div id="aboutBox" class="boxed">
<h1><img src="/ColorVisionEye.jpg" class="round-image" width="50"/>Cvisim 色觉模拟器</h1>
<p>这个模拟器是我业余时间开发的，旨在帮助更多人了解色觉异常者的世界、辅助无障碍设计等。如果您有任何问题，欢迎加QQ群774258636交流。</p>
<h2>使用方法</h2>
<p>通过左上角的文件选择器，<strong>拖放</strong>或者<strong>粘贴</strong>一张图片来加载。然后，你可以选择不同的模拟方式来模拟不同类型的色觉。</p>
<p>所有处理都在你的浏览器本地完成，图片不会上传到服务器。</p>
<p>通过点击和拖动可以移动显示的图片，通过（按住Shift键）双击或者使用鼠标滚轮可以缩放图片。</p>
<p>镜头功能允许你查看原始图片在鼠标周围区域的样子。异常镜头则会在你的鼠标周围区域显示原始图片和模拟图片。</p>
<h2>各色觉类型介绍：</h2>
<p>* 正常色觉（Normal Color Vision）：显示原图</p>
<p>* 红色盲（Protanopia）：缺少L型视锥细胞</p>
<p>* 红色弱（Protanomaly）：L型视锥细胞敏感度曲线发生偏移</p>
<p>* 绿色盲（Deuteranopia）：缺少M型视锥细胞</p>
<p>* 绿色弱（Deuteranomaly）：M型视锥细胞敏感度曲线发生偏移</p>
<p>* 蓝色盲（Tritanopia）：缺少S型视锥细胞</p>
<p>* 蓝色弱（Tritanomaly）：S型视锥细胞敏感度曲线发生偏移</p>
<p>* 全色盲（Achromatopsia）（不模拟畏光、视力差等效果）：缺少所有类型的视锥细胞</p>
<p>* （暮光）正常视觉（Mesopic vision）：正常视觉在暮光下看到的样子，此时视锥细胞和视杆细胞同时主导视觉，详见Purkinje effect（薄暮现象）</p>
<p>* 黄色盲（Tetartanopia）：理论上的一种色盲，蓝黄拮抗出现异常，但可能不存在</p>
<p>* 黄色弱（Tetartanomaly）：同上</p>
<p>* 蓝锥单色视（Blue-cone monochromacy）：只有S型视锥细胞正常工作</p>
<p>* 红锥单色视（Red-cone monochromacy）：只有L型视锥细胞正常工作</p>
<p>* 绿锥单色视（Green-cone monochromacy）：只有M型视锥细胞正常工作</p>
<p>* 红蓝通道互换（Flip Red-Blue）：互换R和B通道，帮助色觉异常者区分之前较难区分的颜色，或探究色盲悖论</p>
<h2>模拟方法介绍</h2>
<p>本模拟的大部分代码来自MaPePeR的开源模拟器<a href="http://mapeper.github.io/jsColorblindSimulator/">http://mapeper.github.io/jsColorblindSimulator/</a>，在此表示感谢。</p>
<p>Simon-Liedtke, J. T., & Farup, I. (2016) 对比了多种模拟方法，最终得出Brettel的模拟是最准确的。</p>
<p>本网页的异常三色视觉和二色视觉（除了Tetartan）均使用Brettel et al. 1997进行模拟，比常用的HCIRN模拟方法准确。</p>
<p>Tetartan使用HCIRN方法进行模拟，因为这种色觉异常只是理论上的，本网页仅使用HCIRN进行近似模拟。</p>
<p>锥状单色视使用sRGB->LMS->去掉两种通道->sRGB的方法模拟，仅根据理论推算，没有经过验证，不能确保准确。</p>
<p>全色盲模拟的过程是是sRGB->linearRGB->模拟->sRGB，仅经过了一位全色盲的验证，不能确保准确。</p>
<h2>我是色弱/色盲，哪些模拟对我来说是准确的？</h2>
<p>对于任何色觉异常来说，“正常色觉”和“（暮光）正常视觉”都是不准确的。</p>
<p>对于红绿色弱来说，“红色弱”或者“绿色弱”会模拟一个程度比你严重的色弱视图，“（暮光）正常视觉”可以模拟你在暮光下大概看到的景象，蓝黄色盲和蓝黄色弱均不准确，剩下的模拟和正常人看到的是一样的。</p>
<p>对于蓝色弱来说，“蓝色弱”会模拟一个程度比你严重的色弱视图，红绿色弱、红绿色盲和黄色弱都不准确，“（暮光）正常视觉”可以模拟你在暮光下大概看到的景象，剩下的模拟和正常人看到的是一样的。</p>
<p>对于红绿色盲来说，在红绿色弱的基础上，“红色弱”和“绿色弱”的模拟也不准确。</p>
<p>对于蓝色盲来说，在蓝色弱的基础上，“蓝色弱”的模拟也不准确。</p>
<p>对于单色视者（如全色盲、蓝锥单色视）来说，只有单色视觉的模拟才是准确的。</p>
<p>以上内容不讨论“红蓝通道互换”，因为这是用来帮助色觉异常者区分颜色的。</p>
<h2>RGB和LMS互转</h2>
<style>
    #colorBox {
        width: 100px;
        height: 100px;
        background-color: rgb(0, 0, 0);
    }
</style>
<div id="colorBox"></div>
<p>Red: <input type="range" min="0" max="255" id="redSlider" value="0"> <input type="number" min="0" max="255" id="redInput" value="0"></p>
<p>Green: <input type="range" min="0" max="255" id="greenSlider" value="0"> <input type="number" min="0" max="255" id="greenInput" value="0"></p>
<p>Blue: <input type="range" min="0" max="255" id="blueSlider" value="0"> <input type="number" min="0" max="255" id="blueInput" value="0"></p>
<p>L: <input type="range" min="0" max="1" step="0.01" id="LSlider" value="0"> <input type="number" min="0" max="1" step="0.01" id="LInput" value="0"></p>
<p>M: <input type="range" min="0" max="1" step="0.01" id="MSlider" value="0"> <input type="number" min="0" max="1" step="0.01" id="MInput" value="0"></p>
<p>S: <input type="range" min="0" max="1" step="0.01" id="SSlider" value="0"> <input type="number" min="0" max="1" step="0.01" id="SInput" value="0"></p>

<script>
    // RGB sliders and inputs
    var redSlider = document.getElementById("redSlider");
    var greenSlider = document.getElementById("greenSlider");
    var blueSlider = document.getElementById("blueSlider");
    var redInput = document.getElementById("redInput");
    var greenInput = document.getElementById("greenInput");
    var blueInput = document.getElementById("blueInput");

    // LMS sliders and inputs
    var LSlider = document.getElementById("LSlider");
    var MSlider = document.getElementById("MSlider");
    var SSlider = document.getElementById("SSlider");
    var LInput = document.getElementById("LInput");
    var MInput = document.getElementById("MInput");
    var SInput = document.getElementById("SInput");

    var colorBox = document.getElementById("colorBox");

    // RGB to LMS conversion matrix
    var rgb2lms = [
        [0.3811, 0.5783, 0.0402],
        [0.1967, 0.7244, 0.0782],
        [0.0241, 0.1288, 0.8444]
    ];

    // LMS to RGB conversion matrix
    var lms2rgb = [
        [4.4679, -3.5873, 0.1193],
        [-1.2186, 2.3809, -0.1624],
        [0.0497, -0.2439, 1.2045]
    ];

        function matrixMultiply(a, b) {
            var result = [0, 0, 0];
            for (var i = 0; i < 3; i++) {
                for (var j = 0; j < 3; j++) {
                    result[i] += a[i][j] * b[j];
                }
            }
            return result;
        }

        function setColorFromRGB() {
            var rgb = [redSlider.value / 255, greenSlider.value / 255, blueSlider.value / 255];
            var lms = matrixMultiply(rgb2lms, rgb);

            colorBox.style.backgroundColor = "rgb(" + rgb.map(v => v * 255) + ")";
            redInput.value = redSlider.value;
            greenInput.value = greenSlider.value;
            blueInput.value = blueSlider.value;

            LSlider.value = LInput.value = lms[0];
            MSlider.value = MInput.value = lms[1];
            SSlider.value = SInput.value = lms[2];
        }

        function setColorFromLMS() {
            var lms = [LSlider.value, MSlider.value, SSlider.value];
            var rgb = matrixMultiply(lms2rgb, lms);
            var rgbScaled = rgb.map(v => v * 255);

            // Check if RGB values are within the valid range
            if (rgbScaled.every(value => value >= 0 && value <= 255)) {
                colorBox.style.backgroundColor = "rgb(" + rgbScaled + ")";
                redSlider.value = redInput.value = rgbScaled[0];
                greenSlider.value = greenInput.value = rgbScaled[1];
                blueSlider.value = blueInput.value = rgbScaled[2];

                LInput.value = LSlider.value;
                MInput.value = MSlider.value;
                SInput.value = SSlider.value;
            }
        }

        redSlider.addEventListener("input", setColorFromRGB);
        greenSlider.addEventListener("input", setColorFromRGB);
        blueSlider.addEventListener("input", setColorFromRGB);
        redInput.addEventListener("input", setColorFromRGB);
        greenInput.addEventListener("input", setColorFromRGB);
        blueInput.addEventListener("input", setColorFromRGB);

        LSlider.addEventListener("input", setColorFromLMS);
        MSlider.addEventListener("input", setColorFromLMS);
        SSlider.addEventListener("input", setColorFromLMS);
        LInput.addEventListener("input", setColorFromLMS);
        MInput.addEventListener("input", setColorFromLMS);
        SInput.addEventListener("input", setColorFromLMS);
</script>
        </div>
        <div class="container" style="">
            <div>
                <input type="file" id="fileInput"/>
<label><input type="radio" name="colorblindType" value="Normal" checked/>正常色觉</label>
<label><input type="radio" name="colorblindType" value="Protanopia"/>红色盲</label>
<label><input type="radio" name="colorblindType" value="Protanomaly"/>红色弱（~10 nm）</label>
<label><input type="radio" name="colorblindType" value="Deuteranopia"/>绿色盲</label>
<label><input type="radio" name="colorblindType" value="Deuteranomaly"/>绿色弱（~10 nm）</label>
<label><input type="radio" name="colorblindType" value="Tritanopia"/>蓝色盲</label>
<label><input type="radio" name="colorblindType" value="Tritanomaly"/>蓝色弱</label>
<label><input type="radio" name="colorblindType" value="Achromatopsia"/>全色盲</label>
<label><input type="radio" name="colorblindType" value="Achromatomaly"/>（暮光）正常视觉</label>	    
<label><input type="radio" name="colorblindType" value="Tetartanopia"/>黄色盲</label>
<label><input type="radio" name="colorblindType" value="Tetartanomaly"/>黄色弱</label>
<label><input type="radio" name="colorblindType" value="BCM"/>蓝锥单色视</label>
<label><input type="radio" name="colorblindType" value="RCM"/>红锥单色视</label>
<label><input type="radio" name="colorblindType" value="GCM"/>绿锥单色视</label>
<label><input type="radio" name="colorblindType" value="Flip"/>红蓝通道互换</label>
<label style="margin-left: 1em;display: none;">Severity:<input type="range" min="0" max="100" value="50" class="slider" id="severity"></label>

<select id="method">
    <option value="simpl">Simple (ColorMatrix)</option>
    <option value="hcirn">Non-commercial-only (HCIRN)</option>
    <option value="brett" selected>Accurate (Brettel et al. 1997)</option>
    <option value="macha">Accurate (Machado et al. 2009)</option>
</select>
<br/>
<label><input type="radio" name="lens" value="No" checked/>无镜头</label>
<label><input type="radio" name="lens" value="Normal"/>正常镜头</label>
<label><input type="radio" name="lens" value="Inverse"/>异常镜头</label>
&nbsp; <a href="#" onclick="panZoomImage.translateX=0;panZoomImage.translateY=0;panZoomImage.scale=1;panZoomImage.redraw();">重置视图</a>
&nbsp; <a href="#" target="blank" id="imageLink" style="display: none">在新窗口中打开模拟后的图片</a>
<span id="loadingIndicator" style="display:none">&nbsp;正在生成模拟图片...</span>
            </div>
            <div>
                <hr/>
            </div>
            <div style="height: 100%" id="canvasDiv">
                <div id="dropNotification" class="boxed" style="display: none"><h1>Drop your image to load it</h1></div>
                <canvas id="outCanvas">Your Browser does not support &lt;canvas&gt;. Get an upgrade!</canvas>
            </div>
        </div>
        <script src="panZoomImage.js"></script>
        <script src="brettel_colorblind_simulation.js"></script>
        <script src="hcirn_colorblind_simulation.js"></script>
        <script src="colorblind.js"></script>
        <script type="text/javascript">

var loadingIndicator = document.getElementById('loadingIndicator');
function filterOrImageChanged() {

    var type = document.querySelector('input[name = "colorblindType"]:checked').value;
	var method;
	if (type == "Tetartanopia" || type == "Tetartanomaly") {
		method = "hcirn";
	}
	else {
		method = "brett";
	}
    var filterName = method + type;
    console.log("filterOrImageChanged: " + filterName);

    document.getElementById('imageLink').style.display = type === "Normal" ? "none" : "inline";
    var isMachado = method == "macha";
    document.getElementById('severity').parentElement.style.display = isMachado ? 'inline' : 'none';
    ['Protanopia', 'Deuteranopia', 'Tritanopia', 'Achromatopsia', 'Tetartanopia', 'Tetartanomaly', 'BCM', 'RCM', 'GCM', 'Flip'].forEach((item, i) => {
        document.querySelector('input[type="radio"][value="' + item + '"]').parentElement.style.display = isMachado ? 'none' : 'inline';
    });
    if (method == 'macha' && type != "Normal") {
        filterName += "_" + document.getElementById('severity').value
    }


    if (currentImage) {
        loadingIndicator.style.display="inline";
        NProgress.set(0.2);
        setTimeout(function () {
            getFilteredImage(currentImage, filterName, function (filteredImage, url) {
                document.getElementById('imageLink').href = url;
                panZoomImage.displayImage(filteredImage);
                NProgress.done();
                loadingIndicator.style.display="none";
            });
        }, 0);
    }
}

function lensChanged() {
    var v = document.querySelector('input[name = "lens"]:checked').value;
    if (v === "No") {
        panZoomImage.lens = 0;
    } else if (v === "Normal") {
        panZoomImage.lens = 1;
    } else if (v === "Inverse") {
        panZoomImage.lens = 2;
    } else {
        throw "Illegal Lens Type";
    }
    panZoomImage.redraw();
}
(function() {
    var radios = document.querySelectorAll('input[name = "colorblindType"]');
    var i;
    for (i = 0; i < radios.length; i++) {
        radios[i].onclick = filterOrImageChanged;
    }
    radios = document.querySelectorAll('input[name = "lens"]');
    for (i = 0; i < radios.length; i++) {
        radios[i].onclick = lensChanged;
    }
    document.getElementById("method").onchange = filterOrImageChanged;
    document.getElementById("severity").onchange = filterOrImageChanged;
	document.getElementById("fileInput").onchange = filterOrImageChanged;
})();

//Based on http://stackoverflow.com/a/3814285/2256700
var fileInput = document.getElementById('fileInput');
var currentImage;
fileInput.onchange = function (evt) {
    var tgt = evt.target || window.event.srcElement,
        files = tgt.files;
    readFile(files);
};

function readFile(files) {
    document.getElementById("aboutBox").style.display = "none";
    // FileReader support
    if (FileReader && files && files.length) {
        if (files.length !== 1) {
            alert("Can only show one file at a time");
            return;
        }
        if (!files[0].type.match('image.*')) {
            alert("Was not an image file. :(");
            return;
        }
        NProgress.set(0.0);
        var fr = new FileReader();
        fr.onload = function () {
            var img = new Image();
            img.onload = function () {
                //createFilteredImage(this);
                currentImage = this;
                panZoomImage.setHiddenLensImage(currentImage);
                clearImageCache();
                filterOrImageChanged();
            };
            img.src = fr.result;
        };
        fr.readAsDataURL(files[0]);
    }
    // Not supported
    else {
        alert("Your Browser does not support the required Features.");
    }
}
var canvasDiv = document.getElementById("canvasDiv");
var dropNotification = document.getElementById("dropNotification");
// Based on http://www.html5rocks.com/en/tutorials/file/dndfiles/
canvasDiv.addEventListener('drop', function (evt) {
    evt.stopPropagation();
    evt.preventDefault();

    dropNotification.style.display = "none";
    readFile(evt.dataTransfer.files);
}, false);

canvasDiv.addEventListener('dragover', function (evt) {
    document.getElementById("aboutBox").style.display = "none";
    evt.stopPropagation();
    evt.preventDefault();
    dropNotification.style.display = "block";
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}, false);

canvasDiv.addEventListener('dragleave', function (evt) {
    dropNotification.style.display = "none";
}, false);

//Retrieve Image from Clipboard: http://stackoverflow.com/a/15369753/2256700
document.onpaste = function (event) {
    // use event.originalEvent.clipboard for newer chrome versions
    var items = (event.clipboardData  || event.originalEvent.clipboardData).items;
    // find pasted image among pasted items
    var blob = null;
    for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") === 0) {
            blob = items[i].getAsFile();
        }
    }
    // load image if there is a pasted image
    if (blob !== null) {
        readFile([blob]);
    }
};
        </script>
    </body>
</html>
